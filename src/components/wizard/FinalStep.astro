---
import Header from './final-step/Header.astro';
import ValidationCard from './final-step/ValidationCard.astro';
import ContactForm from './final-step/ContactForm.astro';
import TrustMessage from './final-step/TrustMessage.astro';
import BookingModal from '../BookingModal.astro';
---

<div>
  <Header />

  <div
    class="bg-gradient-to-br dark:from-slate-700 dark:to-gray-900 rounded-xl border-2 border-slate-200 dark:border-gray-600 shadow-lg p-6 max-w-2xl mx-auto"
  >
    <ValidationCard />
    <ContactForm />
    <TrustMessage />
  </div>
</div>

<BookingModal />

<script>
  import { handleQuoteSubmit } from '../../lib/handleQuoteSubmit';
  import { sanitizeInput } from '../../utils/sanitize';

  if (typeof window === 'undefined') {
    throw new Error('This script should only run on the client');
  }

  function initializeFinalStep() {
    const sendEmail = document.getElementById("sendEmailBtn") as HTMLButtonElement | null;
    const openBookingBtn = document.getElementById("open-booking-modal") as HTMLButtonElement | null;
    const contactForm = document.getElementById("contactForm") as HTMLFormElement | null;

    if (!sendEmail || !openBookingBtn || !contactForm) {
      console.error('[FinalStep] Required elements not found');
      return;
    }

    const cleanup = () => {
      sendEmail.removeEventListener('click', handleEmailClick);
      openBookingBtn.removeEventListener('click', handleBookingClick);
    };

    const handleEmailClick = async (e: Event) => {
      e.preventDefault();

      if (contactForm.checkValidity()) {
        sendEmail.disabled = true;
        sendEmail.textContent = 'Enviando...';
        
        try {
          await handleQuoteSubmit(e);
        } catch (error) {
          console.error('[FinalStep] Error sending quote:', error);
          alert('Hubo un error al enviar la cotización. Por favor intenta nuevamente.');
        } finally {
          sendEmail.disabled = false;
          sendEmail.textContent = 'Enviar Cotización';
        }
      } else {
        contactForm.reportValidity();
      }
    };

    const handleBookingClick = () => {
      if (!contactForm.checkValidity()) {
        contactForm.reportValidity();
        return;
      }
      
      const nameInput = document.getElementById("userName") as HTMLInputElement | null;
      const emailInput = document.getElementById("userEmail") as HTMLInputElement | null;
      const companyInput = document.getElementById("companyName") as HTMLInputElement | null;
      const phoneInput = document.getElementById("userPhone") as HTMLInputElement | null;

      if (!nameInput || !emailInput) {
        console.error('[FinalStep] Required form inputs not found');
        alert('Error: No se pudieron obtener los datos del formulario');
        return;
      }

      const clientName = sanitizeInput.name(nameInput.value || '');
      const clientEmail = sanitizeInput.email(emailInput.value || '');
      const clientCompany = sanitizeInput.company(companyInput?.value || '');
      const clientPhone = sanitizeInput.phone(phoneInput?.value || '');

      if (!clientName || !clientEmail) {
        alert('Por favor completa tu nombre y email correctamente');
        return;
      }

      if (typeof window.openBookingModal !== 'function') {
        console.error('[FinalStep] openBookingModal function not found');
        alert('Error: No se pudo abrir el modal de reserva');
        return;
      }

      try {
        window.openBookingModal({
          name: clientName,
          email: clientEmail,
          company: clientCompany,
          phone: clientPhone
        });
      } catch (error) {
        console.error('[FinalStep] Error opening booking modal:', error);
        alert('Hubo un error al abrir el modal. Por favor intenta nuevamente.');
      }
    };

    sendEmail.addEventListener("click", handleEmailClick);
    openBookingBtn.addEventListener("click", handleBookingClick);

    document.addEventListener('astro:before-preparation', cleanup, { once: true });
    
    return cleanup;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeFinalStep);
  } else {
    initializeFinalStep();
  }
</script>