---
import Header from './final-step/Header.astro';
import ValidationCard from './final-step/ValidationCard.astro';
import ContactForm from './final-step/ContactForm.astro';
import TrustMessage from './final-step/TrustMessage.astro';
import BookingModal from '../BookingModal.astro';
---

<div>
  <Header />

  <div
    class="bg-gradient-to-br dark:from-slate-700 dark:to-gray-900 rounded-xl border-2 border-slate-200 dark:border-gray-600 shadow-lg p-6 max-w-2xl mx-auto"
  >
    <ValidationCard />
    <ContactForm />
    <TrustMessage />
  </div>
</div>

<BookingModal />

<script>
  import { handleQuoteSubmit } from '../../lib/handleQuoteSubmit';
  import { sanitizeInput } from '../../utils/sanitize';

  const sendEmail = document.getElementById("sendEmailBtn") as HTMLButtonElement;
  sendEmail.addEventListener("click", async (e) => {
    const contactForm = document.getElementById("contactForm") as HTMLFormElement;
    if (contactForm.checkValidity()) {
      sendEmail.disabled = true;
      sendEmail.textContent = 'Enviando...';
      try {
        await handleQuoteSubmit(e);
      } finally {
        sendEmail.disabled = false;
        sendEmail.textContent = 'Enviar Cotización';
      }
    } else {
      contactForm.reportValidity();
    }
  });

  // Abrir modal de reserva
  const openBookingBtn = document.getElementById("open-booking-modal");
  openBookingBtn?.addEventListener("click", () => {
    const contactForm = document.getElementById("contactForm") as HTMLFormElement;
    
    // VALIDAR FORMULARIO ANTES DE ABRIR MODAL
    if (contactForm.checkValidity()) {
      // Obtener datos del formulario con los IDs correctos
      const nameInput = document.getElementById("userName") as HTMLInputElement;
      const emailInput = document.getElementById("userEmail") as HTMLInputElement;

      const clientName = sanitizeInput.name(nameInput?.value || '');
      const clientEmail = sanitizeInput.email(emailInput?.value || '');

      // Validar que los datos existan después de sanitizar
      if (!clientName || !clientEmail) {
        alert('Por favor completa tu nombre y email correctamente');
        return;
      }

      // Pasar datos al modal
      window.openBookingModal({
        name: clientName,
        email: clientEmail
      });
    } else {
      contactForm.reportValidity();
    }
  });
</script>