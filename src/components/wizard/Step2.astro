---
import paquetes from "@/data/paquetes.json";
import PaqueteItem from "./paquetes/PaqueteItem.astro";
const { data } = Astro.props;
---

<!-- integrando paquetes -->
<form class="pt-4 max-w-3xl mx-auto" id="step2Form">
  <input type="hidden" name="step" value="2" />
  <div class="space-y-4">
    <h2 class="text-xl font-medium">
      2. Selecciona el paquete que mejor se adapte a tu operación
    </h2>
    <div
      id="paquetesContainer"
      class="flex flex-col gap-4 w-full max-w-4xl mt-2"
    >
      {
        paquetes.map((paquete) => (
          <PaqueteItem
            paquete={paquete}
            isSelected={data.packageId === paquete.id}
          />
        ))
      }
    </div>
    <div class="flex justify-between">
      <!-- VOLVER -->
      <button 
        type="button" 
        id="backBtn"
        class="px-4 py-2 border rounded-md text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
      >
        Volver
      </button>

      <!-- CONTINUAR -->
      <button
        type="submit"
        id="submitBtn"
        class="bg-slate-600 text-white px-4 py-2 rounded-md hover:bg-slate-700 transition-colors"
      >
        Continuar
      </button>
    </div>
  </div>
</form>

<script>
  import { actions } from "astro:actions";

  const form = document.querySelector("#step2Form") as HTMLFormElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
  const backBtn = document.getElementById("backBtn") as HTMLButtonElement;
  const paqueteCards = form.querySelectorAll(".paqueteCard");

  // Botón volver sin recargar
  backBtn.addEventListener("click", () => {
    document.dispatchEvent(new CustomEvent('wizard:prev'));
  });

  paqueteCards.forEach((card) => {
    const toggleButton = card.querySelector(
      ".toggle-details"
    ) as HTMLButtonElement;
    const detailsContent = card.querySelector(
      ".details-content"
    ) as HTMLDivElement;
    const svg = toggleButton.querySelector("svg")!;

    toggleButton.addEventListener("click", () => {
      const isHidden = detailsContent.classList.contains("hidden");
      detailsContent.classList.toggle("hidden");
      svg.style.transform = isHidden ? "rotate(180deg)" : "rotate(0deg)";
    });

    const radioInput = card.querySelector(
      'input[type="radio"]'
    ) as HTMLInputElement;
    card.addEventListener("click", (e) => {
      if ((e.target as HTMLElement).closest(".toggle-details")) return;

      radioInput.checked = true;
      paqueteCards.forEach((otherCard) => {
        otherCard.classList.remove("border-blue-600", "bg-blue-50/40");
        otherCard.classList.add(
          "border-slate-100",
          "bg-white",
          "dark:bg-gray-800"
        );
      });
      card.classList.add("border-blue-600", "bg-blue-50/40");
      card.classList.remove("border-slate-100", "bg-white", "dark:bg-gray-800");
    });
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const selectedPackage = form.querySelector(
      'input[name="packageId"]:checked'
    ) as HTMLInputElement;
    if (!selectedPackage) {
      alert("Por favor, selecciona un paquete para continuar.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Guardando...";

    try {
      const formData = new FormData(form);
      const response = await actions.wizardStep(formData);

      if (response.data?.success) {
        // Navegar al siguiente step sin recargar
        document.dispatchEvent(new CustomEvent('wizard:next'));
      } else {
        alert(
          "Ocurrió un error al guardar tu selección. Por favor, intenta de nuevo."
        );
      }
    } catch (error) {
      console.error("Error submitting form:", error);
      alert(
        "Ocurrió un error al guardar tu selección. Por favor, intenta de nuevo."
      );
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Continuar";
    }
  });
</script>
