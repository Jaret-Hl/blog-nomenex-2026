---
import paquetes from "@/data/paquetes.json";
import PaqueteItem from "./paquetes/PaqueteItem.astro";
const { data } = Astro.props;
---

<!-- integrando paquetes -->
<form class="pt-4 max-w-3xl mx-auto" id="step2Form">
  <input type="hidden" name="step" value="2" />
  <input type="hidden" name="packageId" id="selectedPackageId" value={data.packageId || ""} />
  <div class="space-y-4">
    <h2 class="text-xl font-medium">
      2. Selecciona el paquete que mejor se adapte a tu operación
    </h2>
    <div
      id="paquetesContainer"
      class="flex flex-col gap-4 w-full max-w-4xl mt-2"
    >
      {
        paquetes.map((paquete) => (
          <PaqueteItem
            paquete={paquete}
            isSelected={data.packageId === paquete.id}
          />
        ))
      }
    </div>
    <div class="flex justify-between">
      <!-- VOLVER -->
      <button
        type="button"
        id="backBtn"
        class="px-4 py-2 border rounded-md text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
      >
        Volver
      </button>

      <!-- CONTINUAR -->
      <button
        type="submit"
        id="submitBtn"
        class="bg-slate-600 text-white px-4 py-2 rounded-md hover:bg-slate-700 transition-colors"
      >
        Continuar
      </button>
    </div>
  </div>
</form>

<script>
  import { actions } from "astro:actions";
  import { AlertManager } from "../../lib/alertUtils";

  const form = document.querySelector("#step2Form") as HTMLFormElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
  const backBtn = document.getElementById("backBtn") as HTMLButtonElement;
  const paqueteCards = form.querySelectorAll(".paqueteCard");
  const hiddenInput = document.getElementById("selectedPackageId") as HTMLInputElement;

  // Botón volver sin recargar
  backBtn.addEventListener("click", () => {
    document.dispatchEvent(new CustomEvent("wizard:prev"));
  });

  paqueteCards.forEach((card) => {
    const toggleButton = card.querySelector(
      ".toggle-details"
    ) as HTMLButtonElement;
    const detailsContent = card.querySelector(
      ".details-content"
    ) as HTMLDivElement;
    const svg = toggleButton.querySelector("svg")!;

    toggleButton.addEventListener("click", () => {
      const isHidden = detailsContent.classList.contains("hidden");
      detailsContent.classList.toggle("hidden");
      svg.style.transform = isHidden ? "rotate(180deg)" : "rotate(0deg)";
    });

    card.addEventListener("click", (e) => {
      if ((e.target as HTMLElement).closest(".toggle-details")) return;

      const packageId = card.getAttribute("data-package-id");
      hiddenInput.value = packageId || "";

      paqueteCards.forEach((otherCard) => {
        otherCard.classList.remove("border-yellow-500", "ring-2", "ring-yellow-400", "shadow-lg");
        otherCard.classList.add("border-slate-200", "dark:border-gray-700");
      });
      
      card.classList.add("border-yellow-500", "ring-2", "ring-yellow-400", "shadow-lg");
      card.classList.remove("border-slate-200", "dark:border-gray-700");
    });
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const selectedPackageId = hiddenInput.value;
    if (!selectedPackageId) {
      window.showAlert(
        "Por favor, selecciona un paquete para continuar.",
        "error"
      );
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "Guardando...";

    try {
      const formData = new FormData(form);
      const response = await actions.wizardStep(formData);

      if (response.error) {
        const errorMessage =
          response.error.message || "Error al guardar el paquete";
        window.showAlert(errorMessage, "error");
        return;
      }

      if (response.data?.success) {
        window.showAlert(
          "✓ Paquete seleccionado correctamente",
          "success",
          1500
        );

        setTimeout(() => {
          document.dispatchEvent(new CustomEvent("wizard:next"));
        }, 1500);
      }
    } catch (error) {
      window.showAlert(
        "Error inesperado. Por favor intenta de nuevo.",
        "error"
      );
      throw error;
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Continuar";
    }
  });
</script>
