---
// import type { WizardData } from "../../types/wizard";
// const { data } = Astro.props as { data: WizardData };
const { data } = Astro.props;
---

<!-- integrando paquetes -->
<form id="step3Form" class="pt-4 max-w-3xl mx-auto">
  <input type="hidden" name="step" value="3" />
  <div class="space-y-4">
    <h2 class="text-xl font-medium">3. Instalación de biométricos</h2>
    <p class="text-sm text-slate-600 dark:text-white/70 mt-2">
      Cuéntanos si requieres instalación y cuántos dispositivos.
    </p>

    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="flex items-center gap-3">
          <input type="radio" name="bioNeeded" value="yes" id="bioNeededYes" />
          <span>Sí, quiero instalar dispositivos</span>
        </label>
        <label class="flex items-center gap-3 mt-3">
          <input
            type="radio"
            name="bioNeeded"
            value="no"
            id="bioNeededNo"
            checked
          />
          <span>No, solo software</span>
        </label>

        <!-- bioDetails oculto por defecto -->
        <div id="bioDetails" class="mt-4 hidden">
          <label class="block text-sm">Número de dispositivos</label>
          <input
            id="bioCount"
            type="number"
            min="0"
            value="1"
            class="mt-1 block w-28 rounded-md border px-3 py-2"
          />

          <label class="block text-sm mt-3">Tipo de dispositivo</label>
          <select
            id="bioType"
            class="mt-1 block w-48 rounded-md border px-3 py-2"
          >
            <option value="basic">Biométrico básico</option>
            <!-- <option value="advanced">Biométrico avanzado</option>
                        <option value="terminal">
                          Terminal (con pantalla)
                        </option> -->
          </select>
        </div>
      </div>

      <div>
        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-md border border-2 border-dashed border-slate-200 dark:border-slate-700 mb-4">
          <div class="font-medium">Incluye</div>
          <ul class="list-disc ml-5 mt-2 text-sm text-slate-600 space-y-1 dark:text-white/70">
            <li>Instalación en sitio</li>
            <li>Configuración y pruebas</li>
            <li>Capacitación inicial</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="flex justify-between">
    <button 
      type="button" 
      id="backBtn"
      class="px-4 py-2 border rounded-md text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
    >
      Volver
    </button>

    <button
      type="submit"
      id="submitBtn"
      class="bg-slate-600 text-white px-4 py-2 rounded-md hover:bg-slate-700 transition-colors"
    >
      Continuar
    </button>
  </div>
</form>

<script>
  import { actions } from "astro:actions";

  const form = document.querySelector("#step3Form") as HTMLFormElement;
  const backBtn = document.getElementById("backBtn") as HTMLButtonElement;
  const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
  const bioNeededYes = document.getElementById("bioNeededYes") as HTMLInputElement;
  const bioNeededNo = document.getElementById("bioNeededNo") as HTMLInputElement;
  const bioDetails = document.getElementById("bioDetails") as HTMLDivElement;

  // Botón volver sin recargar
  backBtn.addEventListener("click", () => {
    document.dispatchEvent(new CustomEvent('wizard:prev'));
  });

  // Mostrar/ocultar detalles biométricos
  [bioNeededYes, bioNeededNo].forEach(radio => {
    radio.addEventListener("change", () => {
      if (bioNeededYes.checked) {
        bioDetails.classList.remove("hidden");
      } else {
        bioDetails.classList.add("hidden");
      }
    });
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.textContent = "Guardando...";

    try {
      const formData = new FormData(form);
      const response = await actions.wizardStep(formData);

      if (response.data?.success) {
        // Navegar al siguiente step sin recargar
        document.dispatchEvent(new CustomEvent('wizard:next'));
      } else {
        alert("Ocurrió un error. Por favor, intenta de nuevo.");
      }
    } catch (error) {
      console.error("Error submitting form:", error);
      alert("Ocurrió un error. Por favor, intenta de nuevo.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Continuar";
    }
  });
</script>
