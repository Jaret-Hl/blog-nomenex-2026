---
const { data } = Astro.props;
---

<form id="step3Form" class="pt-4 max-w-3xl mx-auto">
  <input type="hidden" name="step" value="3" />
  <div class="space-y-4">
    <h2 class="text-xl font-medium">3. Instalación de biométricos</h2>
    <p class="text-sm text-slate-600 dark:text-white/70 mt-2">
      Cuéntanos si requieres instalación y cuántos dispositivos.
    </p>

    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="flex items-center gap-3">
          <input
            type="radio"
            name="bioRequired"
            value="true"
            id="bioNeededYes"
            checked={data.biometric?.bioRequired === true}
          />
          <span>Sí, quiero instalar dispositivos</span>
        </label>
        <label class="flex items-center gap-3 mt-3">
          <input
            type="radio"
            id="bioNeededNo"
            name="bioRequired"
            value="false"
            checked={data.biometric?.bioRequired === false ||
              !data.biometric?.bioRequired}
          />
          <span>No, solo software</span>
        </label>

        <!-- bioDetails oculto por defecto -->
        <div id="bioDetails" class="mt-4 hidden">
          <label class="block text-sm">Número de dispositivos</label>
          <input
            id="bioCount"
            name="bioCount"
            type="number"
            min="1"
            value={data.biometric?.bioCount ?? 1}
            class="mt-1 block w-28 rounded-md border px-3 py-2"
          />

          <label class="block text-sm mt-3">Tipo de dispositivo</label>
          <select
            id="bioType"
            name="bioType"
            class="w-full rounded-md border-2 border-gray-200 dark:border-gray-600 px-3 py-2 text-sm"
          >
            <option
              value="basic"
              selected={data.biometric?.bioType === "basic" ||
                !data.biometric?.bioType}
            >
              Biométrico básico
            </option>
          </select>
        </div>
      </div>

      <div>
        <div
          class="bg-gray-50 dark:bg-gray-800 p-4 rounded-md border border-2 border-dashed border-slate-200 dark:border-slate-700 mb-4"
        >
          <div class="font-medium">Incluye</div>
          <ul
            class="list-disc ml-5 mt-2 text-sm text-slate-600 space-y-1 dark:text-white/70"
          >
            <li>Instalación en sitio</li>
            <li>Configuración y pruebas</li>
            <li>Capacitación inicial</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="flex justify-between">
    <button
      type="button"
      id="backBtn3"
      class="px-4 py-2 border rounded-md text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
    >
      Volver
    </button>

    <button
      type="submit"
      id="submitBtn"
      class="bg-slate-600 text-white px-4 py-2 rounded-md hover:bg-slate-700 transition-colors"
    >
      Continuar
    </button>
  </div>
</form>
<script>
  import { actions } from "astro:actions";
  import { AlertManager } from "../../lib/alertUtils";

  if (typeof window === 'undefined') {
    throw new Error('This script should only run on the client');
  }

  function initializeStep3() {
    const form = document.querySelector("#step3Form") as HTMLFormElement | null;
    const backBtn3 = document.getElementById("backBtn3") as HTMLButtonElement | null;
    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement | null;
    const bioNeededYes = document.getElementById("bioNeededYes") as HTMLInputElement | null;
    const bioNeededNo = document.getElementById("bioNeededNo") as HTMLInputElement | null;
    const bioDetails = document.getElementById("bioDetails") as HTMLDivElement | null;
    const bioCount = document.getElementById("bioCount") as HTMLInputElement | null;
    const bioType = document.getElementById("bioType") as HTMLSelectElement | null;

    if (!form || !backBtn3 || !submitBtn || !bioNeededYes || !bioNeededNo || !bioDetails || !bioCount || !bioType) {
      console.error('[Step3] Required elements not found');
      return;
    }

    const cleanup = () => {
      backBtn3.removeEventListener('click', handleBack);
      bioNeededYes.removeEventListener('change', handleBioYes);
      bioNeededNo.removeEventListener('change', handleBioNo);
      form.removeEventListener('submit', handleSubmit);
    };

    function initializeBioDetails() {
      if (bioNeededYes && bioNeededYes.checked) {
        bioDetails?.classList.remove("hidden");
      } else {
        bioDetails?.classList.add("hidden");
      }
    }

    const handleBack = (e: Event) => {
      e.preventDefault();
      document.dispatchEvent(new CustomEvent("wizard:prev"));
    };

    const handleBioYes = () => {
      if (bioNeededYes.checked) {
        bioDetails.classList.remove("hidden");
      }
    };

    const handleBioNo = () => {
      if (bioNeededNo.checked) {
        bioDetails.classList.add("hidden");
      }
    };

    function validateForm(): boolean {
      if (!bioNeededYes || !bioNeededNo || !bioNeededYes.checked && !bioNeededNo.checked) {
        if (typeof window.showAlert === 'function') {
          window.showAlert("Por favor, selecciona si requieres instalación de dispositivos.", "error");
        }
        return false;
      }

      if (bioNeededYes.checked) {
        const countValue = parseInt(bioCount?.value || '');

        if (!bioCount?.value || countValue < 1) {
          if (typeof window.showAlert === 'function') {
            window.showAlert("Por favor, ingresa un número válido de dispositivos (mínimo 1).", "error");
          }
          bioCount?.focus();
          return false;
        }

        if (countValue > 100) {
          if (typeof window.showAlert === 'function') {
            window.showAlert("El número máximo de dispositivos es 100. Para cantidades mayores, contacta a ventas.", "error");
          }
          bioCount?.focus();
          return false;
        }

        if (!bioType?.value) {
          if (typeof window.showAlert === 'function') {
            window.showAlert("Por favor, selecciona el tipo de dispositivo.", "error");
          }
          bioType?.focus();
          return false;
        }
      }

      return true;
    }

    const handleSubmit = async (e: Event) => {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Guardando...";

      try {
        const formData = new FormData(form);

        if (bioNeededNo.checked) {
          formData.set("bioRequired", "false");
          formData.delete("bioCount");
          formData.delete("bioType");
        } else {
          formData.set("bioRequired", "true");
          const count = parseInt(bioCount.value) || 1;
          formData.set("bioCount", count.toString());
          const type = bioType.value || "basic";
          formData.set("bioType", type);
        }

        const response = await actions.wizardStep(formData);

        if (response.error) {
          const errorMessage = response.error.message || "Error al guardar la configuración biométrica";
          if (typeof window.showAlert === 'function') {
            window.showAlert(errorMessage, "error");
          }
          return;
        }
        if (response.data?.success) {
          if (typeof window.showAlert === 'function') {
            window.showAlert("✓ Configuración biométrica guardada", "success", 1500);
          }

          setTimeout(() => {
            document.dispatchEvent(new CustomEvent("wizard:next"));
          }, 1500);
        }
      } catch (error) {
        if (typeof window.showAlert === 'function') {
          window.showAlert("Error inesperado. Por favor intenta de nuevo.", "error");
        }
        console.error('[Step3] Submit error:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Continuar";
      }
    };

    initializeBioDetails();

    backBtn3.addEventListener("click", handleBack);
    bioNeededYes.addEventListener("change", handleBioYes);
    bioNeededNo.addEventListener("change", handleBioNo);
    form.addEventListener("submit", handleSubmit);

    document.addEventListener('astro:before-preparation', cleanup, { once: true });
    
    return cleanup;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeStep3);
  } else {
    initializeStep3();
  }
</script>
